<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digimetric Invoice Generator</title>
    
    <!-- React & ReactDOM (Production Version for Stability) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- HTML2Canvas & JSPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; }
            .invoice-paper { box-shadow: none !important; margin: 0 !important; width: 100% !important; max-width: 100% !important; border: none !important; }
            
            /* Hide Qty controls in Print mode */
            .qty-arrows { display: none !important; }
            .qty-container { border: none !important; }
        }
        /* Hide number input spinners */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Internal Icons Components (Replaces Lucide React Library to fix CDN errors) ---
        const IconWrapper = ({ children, size = 24, className = "" }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} 
                height={size} 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className}
            >
                {children}
            </svg>
        );

        const Printer = (props) => (
            <IconWrapper {...props}>
                <polyline points="6 9 6 2 18 2 18 9"></polyline>
                <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                <rect x="6" y="14" width="12" height="8"></rect>
            </IconWrapper>
        );

        const Save = (props) => (
            <IconWrapper {...props}>
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                <polyline points="7 3 7 8 15 8"></polyline>
            </IconWrapper>
        );

        const History = (props) => (
            <IconWrapper {...props}>
                <path d="M3 3v5h5"></path>
                <path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"></path>
                <path d="M12 7v5l4 2"></path>
            </IconWrapper>
        );

        const Plus = (props) => (
            <IconWrapper {...props}>
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </IconWrapper>
        );

        const Trash2 = (props) => (
            <IconWrapper {...props}>
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
            </IconWrapper>
        );

        const Upload = (props) => (
            <IconWrapper {...props}>
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
            </IconWrapper>
        );

        const FileText = (props) => (
            <IconWrapper {...props}>
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10 9 9 9 8 9"></polyline>
            </IconWrapper>
        );

        const Languages = (props) => (
            <IconWrapper {...props}>
                <path d="m5 8 6 6"></path>
                <path d="m4 14 6-6 2-3"></path>
                <path d="M2 5h12"></path>
                <path d="M7 2h1"></path>
                <path d="m22 22-5-10-5 10"></path>
                <path d="M14 18h6"></path>
            </IconWrapper>
        );

        const ImageIcon = (props) => (
            <IconWrapper {...props}>
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                <polyline points="21 15 16 10 5 21"></polyline>
            </IconWrapper>
        );

        const CheckSquare = (props) => (
            <IconWrapper {...props}>
                <polyline points="9 11 12 14 22 4"></polyline>
                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
            </IconWrapper>
        );

        const ChevronUp = (props) => (
            <IconWrapper {...props}>
                <polyline points="18 15 12 9 6 15"></polyline>
            </IconWrapper>
        );

        const ChevronDown = (props) => (
            <IconWrapper {...props}>
                <polyline points="6 9 12 15 18 9"></polyline>
            </IconWrapper>
        );

        const FileDown = (props) => (
            <IconWrapper {...props}>
                <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <path d="M12 18v-6"></path>
                <path d="m9 15 3 3 3-3"></path>
            </IconWrapper>
        );

        const InvoiceApp = () => {
            // --- State Management ---
            const [libsReady, setLibsReady] = useState(false); // Check for pdf/canvas libs
            const [language, setLanguage] = useState('mm'); // 'mm' or 'en'
            const [activeTab, setActiveTab] = useState('create'); 
            const [history, setHistory] = useState([]);
            const invoiceRef = useRef(null);
            
            // Check if external libs are loaded
            useEffect(() => {
                const checkLibs = () => {
                    if (window.html2canvas && window.jspdf) {
                        setLibsReady(true);
                    } else {
                        setTimeout(checkLibs, 500);
                    }
                };
                checkLibs();
            }, []);

            // Default State definition
            const defaultInvoiceState = {
                invoiceNo: 'INV-001',
                date: new Date().toISOString().slice(0, 10),
                dueDate: '',
                sellerName: 'Your Company Name',
                sellerAddress: 'No.123, Street Name, Yangon',
                sellerPhone: '09-123456789',
                sellerEmail: '',
                customerName: '',
                customerPhone: '',
                customerAddress: '',
                items: [{ id: 1, description: '', quantity: 1, price: 0 }],
                taxRate: 0,
                discount: 0,
                currency: 'MMK',
                logo: null,
                note: '',
                paymentInfo: { 
                    method: '',
                    accountName: '',
                    accountNumber: ''
                }
            };

            const [invoiceData, setInvoiceData] = useState({
                ...defaultInvoiceState,
                id: Date.now()
            });

            // Load history from local storage on mount
            useEffect(() => {
                const savedHistory = localStorage.getItem('invoice_history');
                if (savedHistory) {
                    try {
                        setHistory(JSON.parse(savedHistory));
                    } catch (e) {
                        console.error("Error loading history", e);
                    }
                }
            }, []);

            // Save history to local storage whenever it changes
            useEffect(() => {
                localStorage.setItem('invoice_history', JSON.stringify(history));
            }, [history]);

            // --- Translations ---
            const t = {
                mm: {
                    appTitle: 'Digimetric Invoice Generator',
                    createTab: 'ဘောင်ချာ အသစ်လုပ်မည်',
                    historyTab: 'မှတ်တမ်း (History)',
                    settings: 'ဆက်တင်',
                    billTo: 'ဝယ်ယူသူ အချက်အလက်',
                    from: 'ရောင်းသူ အချက်အလက်',
                    name: 'အမည်',
                    address: 'လိပ်စာ',
                    phone: 'ဖုန်းနံပါတ်',
                    email: 'အီးမေးလ် (Optional)',
                    invoiceNo: 'ဘောင်ချာ နံပါတ်',
                    date: 'ရက်စွဲ',
                    dueDate: 'ငွေချေရမည့်ရက်',
                    item: 'ပစ္စည်းအမျိုးအမည်',
                    qty: 'အရေအတွက်',
                    price: 'စျေးနှုန်း',
                    amount: 'သင့်ငွေ',
                    addItem: 'ပစ္စည်းထပ်ထည့်ရန်',
                    subtotal: 'စုစုပေါင်း (အခွန်မပါ)',
                    tax: 'အခွန်',
                    discount: 'လျှော့စျေး',
                    total: 'စုစုပေါင်း (ကျသင့်ငွေ)',
                    uploadLogo: 'Logo တင်ရန်',
                    removeLogo: 'Logo ဖျက်ရန်',
                    saveToHistory: 'မှတ်တမ်းတွင်သိမ်းမည်',
                    print: 'Print (ပရင်တာ)',
                    saveImage: 'Save as JPG',
                    downloadPdf: 'Download PDF',
                    currency: 'ငွေကြေး',
                    note: 'မှတ်ချက်',
                    emptyHistory: 'မှတ်တမ်း မရှိသေးပါ။',
                    view: 'ပြန်ကြည့်မည်',
                    delete: 'ဖျက်မည်',
                    savedMsg: 'သိမ်းဆည်းပြီးပါပြီ',
                    newInvoice: 'အသစ်လုပ်မည်',
                    paymentHeader: 'ငွေပေးချေရန် အချက်အလက်',
                    paymentMethod: 'ဘဏ် / Payment',
                    accName: 'အကောင့်အမည်',
                    accNum: 'အကောင့်နံပါတ်'
                },
                en: {
                    appTitle: 'Digimetric Invoice Generator',
                    createTab: 'Create Invoice',
                    historyTab: 'History',
                    settings: 'Settings',
                    billTo: 'Bill To',
                    from: 'From',
                    name: 'Name',
                    address: 'Address',
                    phone: 'Phone',
                    email: 'Email (Optional)',
                    invoiceNo: 'Invoice No',
                    date: 'Date',
                    dueDate: 'Due Date',
                    item: 'Description',
                    qty: 'Qty',
                    price: 'Price',
                    amount: 'Amount',
                    addItem: 'Add Item',
                    subtotal: 'Subtotal',
                    tax: 'Tax',
                    discount: 'Discount',
                    total: 'Grand Total',
                    uploadLogo: 'Upload Logo',
                    removeLogo: 'Remove Logo',
                    saveToHistory: 'Save to History',
                    print: 'Print',
                    saveImage: 'Save as JPG',
                    downloadPdf: 'Download PDF',
                    currency: 'Currency',
                    note: 'Note',
                    emptyHistory: 'No history found.',
                    view: 'View',
                    delete: 'Delete',
                    savedMsg: 'Saved successfully',
                    newInvoice: 'New Invoice',
                    paymentHeader: 'Payment Information',
                    paymentMethod: 'Bank / Method',
                    accName: 'Account Name',
                    accNum: 'Account Number'
                }
            };

            const text = t[language];

            // --- Functions ---

            const handleLogoUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setInvoiceData({ ...invoiceData, logo: reader.result });
                    };
                    reader.readAsDataURL(file);
                }
            };

            const handleItemChange = (id, field, value) => {
                const newItems = invoiceData.items.map(item => {
                    if (item.id === id) {
                        return { ...item, [field]: value };
                    }
                    return item;
                });
                setInvoiceData({ ...invoiceData, items: newItems });
            };

            const handleAmountChange = (id, newAmount) => {
                const safeAmount = isNaN(newAmount) ? 0 : newAmount;
                const newItems = invoiceData.items.map(item => {
                    if (item.id === id) {
                        const safeQty = item.quantity || 1; 
                        const newPrice = safeAmount / safeQty;
                        return { ...item, price: newPrice };
                    }
                    return item;
                });
                setInvoiceData({ ...invoiceData, items: newItems });
            };

            const addItem = () => {
                setInvoiceData({
                    ...invoiceData,
                    items: [...invoiceData.items, { id: Date.now(), description: '', quantity: 1, price: 0 }]
                });
            };

            const removeItem = (id) => {
                setInvoiceData({
                    ...invoiceData,
                    items: invoiceData.items.filter(item => item.id !== id)
                });
            };

            const calculateSubtotal = () => {
                return invoiceData.items.reduce((acc, item) => {
                    const lineTotal = (item.quantity || 0) * (item.price || 0);
                    return acc + lineTotal;
                }, 0);
            };

            const calculateTotal = () => {
                const subtotal = calculateSubtotal();
                const taxAmount = subtotal * ((invoiceData.taxRate || 0) / 100);
                return subtotal + taxAmount - (invoiceData.discount || 0);
            };

            const formatCurrency = (amount) => {
                if (isNaN(amount)) amount = 0;
                let symbol = 'Ks';
                let code = 'MMK';
                
                if (invoiceData.currency === 'USD') {
                    symbol = '$';
                    code = 'USD';
                } else if (invoiceData.currency === 'THB') {
                    symbol = '฿';
                    code = 'THB';
                }

                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: code,
                    currencyDisplay: 'narrowSymbol'
                }).format(amount).replace(code, symbol); 
            };

            const saveToHistory = () => {
                const newRecord = { ...invoiceData, savedAt: new Date().toISOString() };
                const existingIndex = history.findIndex(h => h.invoiceNo === invoiceData.invoiceNo);
                
                if (existingIndex >= 0) {
                    const updatedHistory = [...history];
                    updatedHistory[existingIndex] = newRecord;
                    setHistory(updatedHistory);
                } else {
                    setHistory([newRecord, ...history]);
                }
                alert(text.savedMsg);
            };

            const loadFromHistory = (record) => {
                const mergedRecord = {
                    ...defaultInvoiceState,
                    ...record,
                    paymentInfo: {
                        ...defaultInvoiceState.paymentInfo,
                        ...(record.paymentInfo || {})
                    }
                };
                
                setInvoiceData(mergedRecord);
                setActiveTab('create');
            };

            const deleteFromHistory = (invoiceNo) => {
                setHistory(history.filter(h => h.invoiceNo !== invoiceNo));
            };

            const handlePrint = () => {
                window.print();
            };

            // Helper to prepare document clone for capture
            const prepareCloneForCapture = (clonedDoc) => {
                const noPrintElements = clonedDoc.querySelectorAll('.no-print');
                noPrintElements.forEach(el => el.style.display = 'none');
                
                const qtyArrows = clonedDoc.querySelectorAll('.qty-arrows');
                qtyArrows.forEach(el => el.style.display = 'none');
                
                const qtyContainers = clonedDoc.querySelectorAll('.qty-container');
                qtyContainers.forEach(el => el.style.border = 'none');

                const inputs = clonedDoc.querySelectorAll('input, textarea, select');
                
                inputs.forEach(input => {
                    if (input.type === 'text' || input.type === 'number' || input.type === 'email' || input.type === 'date') {
                        const parent = input.parentElement;
                        const textDiv = clonedDoc.createElement('div');
                        
                        textDiv.textContent = input.value;
                        
                        const style = window.getComputedStyle(input);
                        textDiv.style.fontFamily = style.fontFamily;
                        textDiv.style.fontSize = style.fontSize;
                        textDiv.style.fontWeight = style.fontWeight;
                        textDiv.style.color = style.color;
                        textDiv.style.textAlign = style.textAlign;
                        textDiv.style.width = '100%';
                        textDiv.style.padding = style.padding;
                        textDiv.style.marginTop = style.marginTop;
                        textDiv.style.marginBottom = style.marginBottom;
                        
                        if (input.classList.contains('border-b')) {
                            textDiv.style.borderBottom = '1px solid #e5e7eb';
                        }
                        if (style.borderWidth !== '0px' && style.borderStyle !== 'none') {
                            textDiv.style.border = style.border;
                            textDiv.style.borderRadius = style.borderRadius;
                            textDiv.style.backgroundColor = style.backgroundColor;
                            textDiv.style.boxShadow = style.boxShadow;
                        }
                        
                        input.style.display = 'none';
                        if(parent) parent.insertBefore(textDiv, input);
                    }
                    else if (input.tagName === 'TEXTAREA') {
                        const parent = input.parentElement;
                        const textDiv = clonedDoc.createElement('div');
                        textDiv.textContent = input.value;
                        const style = window.getComputedStyle(input);
                        textDiv.style.fontFamily = style.fontFamily;
                        textDiv.style.fontSize = style.fontSize;
                        textDiv.style.whiteSpace = 'pre-wrap';
                        textDiv.style.color = style.color;
                        
                        if (style.borderWidth !== '0px' && style.borderStyle !== 'none') {
                            textDiv.style.border = style.border;
                            textDiv.style.borderRadius = style.borderRadius;
                            textDiv.style.padding = style.padding;
                        }

                        input.style.display = 'none';
                        if(parent) parent.insertBefore(textDiv, input);
                    }
                    else if (input.tagName === 'SELECT') {
                        const selectedOption = input.options[input.selectedIndex];
                        if(selectedOption) selectedOption.setAttribute('selected', 'selected');
                    }
                });
            };

            const handleDownloadImage = async () => {
                if (!window.html2canvas || !invoiceRef.current) return;
                
                try {
                    const canvas = await window.html2canvas(invoiceRef.current, {
                        scale: 2, 
                        backgroundColor: '#ffffff',
                        useCORS: true,
                        onclone: prepareCloneForCapture
                    });
                    
                    const image = canvas.toDataURL("image/jpeg", 0.9);
                    const link = document.createElement('a');
                    link.href = image;
                    link.download = `${invoiceData.invoiceNo}.jpg`;
                    link.click();
                } catch (error) {
                    console.error("Error generating image:", error);
                    alert("Error creating image.");
                }
            };

            const handleDownloadPDF = async () => {
                if (!window.html2canvas || !window.jspdf || !invoiceRef.current) return;

                try {
                    const canvas = await window.html2canvas(invoiceRef.current, {
                        scale: 2,
                        backgroundColor: '#ffffff',
                        useCORS: true,
                        onclone: prepareCloneForCapture
                    });

                    const imgData = canvas.toDataURL('image/png');
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: 'a4'
                    });

                    const imgProps = pdf.getImageProperties(imgData);
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

                    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                    pdf.save(`${invoiceData.invoiceNo}.pdf`);

                } catch (error) {
                    console.error("Error generating PDF:", error);
                    alert("Error creating PDF.");
                }
            };

            const createNew = () => {
                setInvoiceData({
                    ...defaultInvoiceState,
                    id: Date.now(),
                    invoiceNo: `INV-${Math.floor(Math.random() * 10000)}`,
                    date: new Date().toISOString().slice(0, 10),
                    items: [{ id: Date.now(), description: '', quantity: 1, price: 0 }]
                });
            };

            return (
                <div className="min-h-screen bg-gray-100 font-sans text-gray-800">
                    {/* Header Navigation (No Print) */}
                    <header className="no-print bg-white shadow-sm sticky top-0 z-20 border-b border-gray-200">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <FileText className="text-blue-600 w-6 h-6" />
                                <h1 className="text-lg font-bold text-gray-900 hidden sm:block">{text.appTitle}</h1>
                            </div>

                            <div className="flex items-center gap-4">
                                <div className="flex bg-gray-100 p-1 rounded-lg">
                                    <button
                                        onClick={() => setActiveTab('create')}
                                        className={`px-3 py-1.5 text-sm font-medium rounded-md transition-all ${
                                            activeTab === 'create' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'
                                        }`}
                                    >
                                        {text.createTab}
                                    </button>
                                    <button
                                        onClick={() => setActiveTab('history')}
                                        className={`px-3 py-1.5 text-sm font-medium rounded-md transition-all ${
                                            activeTab === 'history' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'
                                        }`}
                                    >
                                        {text.historyTab}
                                    </button>
                                </div>
                                <button
                                    onClick={() => setLanguage(language === 'mm' ? 'en' : 'mm')}
                                    className="flex items-center gap-1 px-3 py-1.5 text-sm font-medium text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200"
                                >
                                    <Languages size={16} />
                                    {language === 'mm' ? 'Eng' : 'မြန်မာ'}
                                </button>
                            </div>
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="max-w-7xl mx-auto px-4 py-8">
                        
                        {activeTab === 'history' ? (
                            // History View
                            <div className="bg-white rounded-xl shadow-sm overflow-hidden">
                                <div className="p-6 border-b border-gray-100">
                                    <h2 className="text-xl font-semibold text-gray-800 flex items-center gap-2">
                                        <History className="w-5 h-5" />
                                        {text.historyTab}
                                    </h2>
                                </div>
                                <div className="overflow-x-auto">
                                    {history.length === 0 ? (
                                        <div className="p-12 text-center text-gray-500">
                                            <History className="w-12 h-12 mx-auto mb-3 opacity-20" />
                                            <p>{text.emptyHistory}</p>
                                        </div>
                                    ) : (
                                        <table className="w-full text-left">
                                            <thead className="bg-gray-50 text-gray-500 text-sm">
                                                <tr>
                                                    <th className="px-6 py-3 font-medium">{text.invoiceNo}</th>
                                                    <th className="px-6 py-3 font-medium">{text.name}</th>
                                                    <th className="px-6 py-3 font-medium">{text.date}</th>
                                                    <th className="px-6 py-3 font-medium text-right">{text.total}</th>
                                                    <th className="px-6 py-3 font-medium text-right">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-100">
                                                {history.map((inv, idx) => (
                                                    <tr key={idx} className="hover:bg-gray-50 transition-colors">
                                                        <td className="px-6 py-4 font-medium text-gray-900">{inv.invoiceNo}</td>
                                                        <td className="px-6 py-4 text-gray-600">{inv.customerName || '-'}</td>
                                                        <td className="px-6 py-4 text-gray-600">{inv.date}</td>
                                                        <td className="px-6 py-4 text-right font-medium text-blue-600">
                                                            {new Intl.NumberFormat('en-US').format(
                                                                inv.items.reduce((acc, item) => acc + (item.quantity * item.price), 0) * (1 + (inv.taxRate || 0)/100) - (inv.discount || 0)
                                                            )}
                                                        </td>
                                                        <td className="px-6 py-4 text-right flex justify-end gap-2">
                                                            <button 
                                                                onClick={() => loadFromHistory(inv)}
                                                                className="p-2 text-blue-600 hover:bg-blue-50 rounded-lg"
                                                                title={text.view}
                                                            >
                                                                <FileText size={18} />
                                                            </button>
                                                            <button 
                                                                onClick={() => deleteFromHistory(inv.invoiceNo)}
                                                                className="p-2 text-red-600 hover:bg-red-50 rounded-lg"
                                                                title={text.delete}
                                                            >
                                                                <Trash2 size={18} />
                                                            </button>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    )}
                                </div>
                            </div>
                        ) : (
                            // Create/Edit View
                            <div className="flex flex-col lg:flex-row gap-8">
                                
                                {/* Editor Sidebar (No Print) */}
                                <div className="no-print w-full lg:w-1/3 space-y-6">
                                    
                                    {/* Actions Card */}
                                    <div className="bg-white p-5 rounded-xl shadow-sm space-y-4">
                                        <button 
                                            onClick={createNew}
                                            className="w-full flex items-center justify-center gap-2 py-2.5 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium transition-colors"
                                        >
                                            <Plus size={18} /> {text.newInvoice}
                                        </button>
                                        <div className="grid grid-cols-2 gap-3">
                                            <button 
                                                onClick={saveToHistory}
                                                className="flex items-center justify-center gap-2 py-2.5 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 font-medium transition-colors"
                                            >
                                                <Save size={18} /> {text.saveToHistory}
                                            </button>
                                            <button 
                                                onClick={handlePrint}
                                                className="flex items-center justify-center gap-2 py-2.5 bg-gray-900 text-white rounded-lg hover:bg-gray-800 font-medium transition-colors"
                                            >
                                                <Printer size={18} /> {text.print}
                                            </button>
                                        </div>
                                        <div className="grid grid-cols-2 gap-3">
                                            {libsReady ? (
                                                <>
                                                    <button 
                                                        onClick={handleDownloadImage}
                                                        className="flex items-center justify-center gap-2 py-2.5 bg-green-50 text-green-600 rounded-lg hover:bg-green-100 font-medium transition-colors border border-green-200 text-sm"
                                                    >
                                                        <ImageIcon size={16} /> {text.saveImage}
                                                    </button>
                                                    <button 
                                                        onClick={handleDownloadPDF}
                                                        className="flex items-center justify-center gap-2 py-2.5 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 font-medium transition-colors border border-red-200 text-sm"
                                                    >
                                                        <FileDown size={16} /> {text.downloadPdf}
                                                    </button>
                                                </>
                                            ) : (
                                                <div className="col-span-2 text-center text-xs text-gray-400 py-2">Loading download tools...</div>
                                            )}
                                        </div>
                                    </div>

                                    {/* Form Card */}
                                    <div className="bg-white p-5 rounded-xl shadow-sm space-y-4 max-h-[calc(100vh-200px)] overflow-y-auto">
                                        <h3 className="font-semibold text-gray-800 border-b pb-2">{text.settings}</h3>
                                        
                                        {/* Logo Upload */}
                                        <div>
                                            <label className="block text-sm font-medium text-gray-600 mb-2">{text.uploadLogo}</label>
                                            <div className="space-y-3">
                                                <div className="flex items-center gap-3">
                                                    <label className="cursor-pointer flex items-center justify-center px-4 py-2 border border-gray-300 border-dashed rounded-lg hover:bg-gray-50 w-full text-sm text-gray-600 transition-colors">
                                                        <Upload size={16} className="mr-2" /> Upload
                                                        <input type="file" className="hidden" accept="image/*" onChange={handleLogoUpload} />
                                                    </label>
                                                    {invoiceData.logo && (
                                                        <button 
                                                            onClick={() => setInvoiceData({...invoiceData, logo: null})}
                                                            className="p-2 text-red-500 hover:bg-red-50 rounded-lg border border-red-100 transition-colors"
                                                            title={text.removeLogo}
                                                        >
                                                            <Trash2 size={16} />
                                                        </button>
                                                    )}
                                                </div>
                                            </div>
                                        </div>

                                        {/* Seller Info */}
                                        <div className="space-y-3 pt-2">
                                            <label className="block text-sm font-medium text-gray-600">{text.from}</label>
                                            <input 
                                                type="text" 
                                                placeholder={text.name}
                                                className="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm"
                                                value={invoiceData.sellerName}
                                                onChange={(e) => setInvoiceData({...invoiceData, sellerName: e.target.value})}
                                            />
                                            <textarea 
                                                placeholder={text.address}
                                                rows="2"
                                                className="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm"
                                                value={invoiceData.sellerAddress}
                                                onChange={(e) => setInvoiceData({...invoiceData, sellerAddress: e.target.value})}
                                            />
                                            <input 
                                                type="text" 
                                                placeholder={text.phone}
                                                className="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm"
                                                value={invoiceData.sellerPhone}
                                                onChange={(e) => setInvoiceData({...invoiceData, sellerPhone: e.target.value})}
                                            />
                                            <input 
                                                type="email" 
                                                placeholder={text.email}
                                                className="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm"
                                                value={invoiceData.sellerEmail}
                                                onChange={(e) => setInvoiceData({...invoiceData, sellerEmail: e.target.value})}
                                            />
                                        </div>

                                        {/* Currency */}
                                        <div className="pt-2">
                                            <div>
                                                <label className="block text-xs font-medium text-gray-500 mb-1">{text.currency}</label>
                                                <select 
                                                    value={invoiceData.currency}
                                                    onChange={(e) => setInvoiceData({...invoiceData, currency: e.target.value})}
                                                    className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm bg-white"
                                                >
                                                    <option value="MMK">MMK (Kyat)</option>
                                                    <option value="USD">USD (Dollar)</option>
                                                    <option value="THB">THB (Baht)</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Invoice Preview Paper */}
                                <div className="w-full lg:w-2/3">
                                    <div 
                                        ref={invoiceRef}
                                        className="invoice-paper bg-white shadow-lg p-4 md:p-12 min-h-[1000px] mx-auto text-sm md:text-base relative rounded-none md:rounded-lg"
                                    >
                                        
                                        {/* Header Section */}
                                        <div className="flex flex-col md:flex-row justify-between items-start mb-8 md:mb-12">
                                            <div className="w-full md:w-1/2 mb-6 md:mb-0">
                                                {invoiceData.logo ? (
                                                    <img 
                                                        src={invoiceData.logo} 
                                                        alt="Company Logo" 
                                                        className="h-20 object-contain mb-4" 
                                                    />
                                                ) : (
                                                    <div className="h-20 w-20 bg-gray-100 rounded-lg flex items-center justify-center text-gray-400 mb-4 border-2 border-dashed border-gray-200">
                                                        <span className="text-xs">Logo</span>
                                                    </div>
                                                )}
                                                <h2 className="text-2xl font-bold text-gray-900 mb-1">{invoiceData.sellerName}</h2>
                                                <p className="text-gray-500 whitespace-pre-line text-sm">{invoiceData.sellerAddress}</p>
                                                <p className="text-gray-500 text-sm">{invoiceData.sellerPhone}</p>
                                                {invoiceData.sellerEmail && (
                                                    <p className="text-gray-500 text-sm">{invoiceData.sellerEmail}</p>
                                                )}
                                            </div>
                                            <div className="w-full md:w-1/2 md:text-right">
                                                <h1 className="text-4xl font-light text-blue-600 mb-6 uppercase tracking-wide">Invoice</h1>
                                                
                                                <div className="flex md:justify-end">
                                                    <table className="w-full md:w-auto border-collapse">
                                                        <tbody>
                                                            <tr>
                                                                <td className="text-gray-500 font-medium pr-4 text-left md:text-right py-1 align-middle">{text.invoiceNo}:</td>
                                                                <td className="text-right py-1">
                                                                    <input 
                                                                        type="text" 
                                                                        className="text-right font-bold text-gray-900 border-b border-dashed border-gray-300 focus:border-blue-500 outline-none w-32 bg-transparent"
                                                                        value={invoiceData.invoiceNo}
                                                                        onChange={(e) => setInvoiceData({...invoiceData, invoiceNo: e.target.value})}
                                                                    />
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <td className="text-gray-500 font-medium pr-4 text-left md:text-right py-1 align-middle">{text.date}:</td>
                                                                <td className="text-right py-1">
                                                                    <input 
                                                                        type="date" 
                                                                        className="text-right text-gray-900 border-b border-dashed border-gray-300 focus:border-blue-500 outline-none w-32 bg-transparent"
                                                                        value={invoiceData.date}
                                                                        onChange={(e) => setInvoiceData({...invoiceData, date: e.target.value})}
                                                                    />
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <td className="text-gray-500 font-medium pr-4 text-left md:text-right py-1 align-middle">{text.dueDate}:</td>
                                                                <td className="text-right py-1">
                                                                    <input 
                                                                        type="date" 
                                                                        className="text-right text-gray-900 border-b border-dashed border-gray-300 focus:border-blue-500 outline-none w-32 bg-transparent"
                                                                        value={invoiceData.dueDate}
                                                                        onChange={(e) => setInvoiceData({...invoiceData, dueDate: e.target.value})}
                                                                    />
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Bill To Section */}
                                        <div className="mb-10 bg-gray-50 p-6 rounded-lg">
                                            <h3 className="text-gray-500 font-bold uppercase text-xs tracking-wider mb-3">{text.billTo}</h3>
                                            <div className="space-y-3">
                                                <div className="grid grid-cols-[80px_1fr] md:grid-cols-[100px_1fr] items-center gap-2">
                                                    <span className="text-xs text-gray-500 font-medium text-right pr-2">{text.name}:</span>
                                                    <input 
                                                        type="text" 
                                                        placeholder={text.name}
                                                        className="w-full bg-white border border-gray-200 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-gray-800 font-medium placeholder-gray-400 shadow-sm"
                                                        value={invoiceData.customerName}
                                                        onChange={(e) => setInvoiceData({...invoiceData, customerName: e.target.value})}
                                                    />
                                                </div>
                                                <div className="grid grid-cols-[80px_1fr] md:grid-cols-[100px_1fr] items-center gap-2">
                                                    <span className="text-xs text-gray-500 font-medium text-right pr-2">{text.phone}:</span>
                                                    <input 
                                                        type="text" 
                                                        placeholder={text.phone}
                                                        className="w-full bg-white border border-gray-200 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-gray-800 placeholder-gray-400 shadow-sm"
                                                        value={invoiceData.customerPhone}
                                                        onChange={(e) => setInvoiceData({...invoiceData, customerPhone: e.target.value})}
                                                    />
                                                </div>
                                                <div className="grid grid-cols-[80px_1fr] md:grid-cols-[100px_1fr] items-start gap-2">
                                                    <span className="text-xs text-gray-500 font-medium text-right pr-2 mt-2">{text.address}:</span>
                                                    <textarea 
                                                        placeholder={text.address}
                                                        rows="2"
                                                        className="w-full bg-white border border-gray-200 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-gray-800 resize-none placeholder-gray-400 shadow-sm"
                                                        value={invoiceData.customerAddress}
                                                        onChange={(e) => setInvoiceData({...invoiceData, customerAddress: e.target.value})}
                                                    />
                                                </div>
                                            </div>
                                        </div>

                                        {/* Items Table */}
                                        <div className="mb-8 overflow-x-auto">
                                            <table className="w-full min-w-[500px]">
                                                <thead>
                                                    <tr className="border-b-2 border-gray-100">
                                                        <th className="text-left py-3 font-bold text-gray-600 w-[40%]">{text.item}</th>
                                                        <th className="text-center py-3 font-bold text-gray-600 w-[15%]">{text.qty}</th>
                                                        <th className="text-right py-3 font-bold text-gray-600 w-[20%]">{text.price}</th>
                                                        <th className="text-right py-3 font-bold text-gray-600 w-[20%]">{text.amount}</th>
                                                        <th className="w-[5%] no-print"></th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-gray-100">
                                                    {invoiceData.items.map((item) => (
                                                        <tr key={item.id} className="group">
                                                            <td className="py-3 pr-2 align-top">
                                                                <textarea 
                                                                    className="w-full bg-transparent outline-none resize-none h-auto overflow-hidden placeholder-gray-300" 
                                                                    placeholder="Item name / description"
                                                                    rows="1"
                                                                    value={item.description}
                                                                    onChange={(e) => handleItemChange(item.id, 'description', e.target.value)}
                                                                    onInput={(e) => { e.target.style.height = 'auto'; e.target.style.height = e.target.scrollHeight + 'px'; }}
                                                                />
                                                            </td>
                                                            <td className="py-3 align-top">
                                                                <div className="qty-container relative flex items-center w-16 mx-auto border border-gray-300 rounded-md overflow-hidden bg-white">
                                                                    <input
                                                                        type="number"
                                                                        className="w-full text-center outline-none px-1 h-8 text-sm"
                                                                        value={item.quantity}
                                                                        onChange={(e) => handleItemChange(item.id, 'quantity', parseInt(e.target.value) || 0)}
                                                                    />
                                                                    <div className="qty-arrows flex flex-col border-l border-gray-300">
                                                                        <button
                                                                            onClick={() => handleItemChange(item.id, 'quantity', item.quantity + 1)}
                                                                            className="flex-1 px-1 bg-gray-50 hover:bg-gray-100 border-b border-gray-300 flex items-center justify-center transition-colors h-4"
                                                                        >
                                                                            <ChevronUp size={10} />
                                                                        </button>
                                                                        <button
                                                                            onClick={() => handleItemChange(item.id, 'quantity', Math.max(1, item.quantity - 1))}
                                                                            className="flex-1 px-1 bg-gray-50 hover:bg-gray-100 flex items-center justify-center transition-colors h-4"
                                                                        >
                                                                            <ChevronDown size={10} />
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </td>
                                                            <td className="py-3 text-right align-top">
                                                                <input 
                                                                    type="number" 
                                                                    className="w-full text-right bg-transparent outline-none"
                                                                    value={item.price}
                                                                    min="0"
                                                                    onChange={(e) => handleItemChange(item.id, 'price', e.target.value === '' ? 0 : parseFloat(e.target.value))}
                                                                />
                                                            </td>
                                                            <td className="py-3 text-right font-medium text-gray-800 align-top">
                                                                <input 
                                                                    type="number"
                                                                    className="w-full text-right bg-transparent outline-none font-medium"
                                                                    value={isNaN(item.quantity * item.price) ? 0 : item.quantity * item.price}
                                                                    onChange={(e) => handleAmountChange(item.id, e.target.value === '' ? 0 : parseFloat(e.target.value))}
                                                                />
                                                            </td>
                                                            <td className="py-3 text-center align-top no-print">
                                                                <button 
                                                                    onClick={() => removeItem(item.id)}
                                                                    className="text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"
                                                                >
                                                                    <Trash2 size={16} />
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                            
                                            <div className="mt-4 no-print">
                                                <button 
                                                    onClick={addItem}
                                                    className="flex items-center gap-2 text-blue-600 text-sm font-medium hover:text-blue-700"
                                                >
                                                    <Plus size={16} /> {text.addItem}
                                                </button>
                                            </div>
                                        </div>

                                        {/* Totals Section */}
                                        <div className="flex justify-end mb-12">
                                            <div className="w-full sm:w-2/3 md:w-1/2 space-y-3">
                                                <div className="flex justify-between text-gray-600">
                                                    <span>{text.subtotal}</span>
                                                    <span className="font-medium">{formatCurrency(calculateSubtotal())}</span>
                                                </div>
                                                
                                                <div className="flex justify-between items-center text-gray-600">
                                                    <div className="flex items-center gap-2">
                                                        <span>{text.tax} (%)</span>
                                                        <input 
                                                            type="number" 
                                                            className="w-12 text-center border-b border-gray-200 focus:border-blue-500 outline-none bg-transparent text-sm py-1"
                                                            value={invoiceData.taxRate}
                                                            onChange={(e) => setInvoiceData({...invoiceData, taxRate: parseFloat(e.target.value) || 0})}
                                                        />
                                                    </div>
                                                    <span className="font-medium">
                                                        {formatCurrency(calculateSubtotal() * (invoiceData.taxRate / 100))}
                                                    </span>
                                                </div>
                                                
                                                <div className="flex justify-between items-center text-gray-600">
                                                    <span>{text.discount}</span>
                                                    <div className="flex items-center justify-end gap-1 w-24">
                                                        <span className="text-gray-400">-</span>
                                                        <input 
                                                            type="number" 
                                                            className="w-full text-right border-b border-gray-200 focus:border-blue-500 outline-none bg-transparent"
                                                            value={invoiceData.discount}
                                                            onChange={(e) => setInvoiceData({...invoiceData, discount: parseFloat(e.target.value) || 0})}
                                                        />
                                                    </div>
                                                </div>
                                                
                                                <div className="border-t-2 border-gray-800 pt-3 flex justify-between text-lg font-bold text-gray-900">
                                                    <span>{text.total}</span>
                                                    <span>{formatCurrency(calculateTotal())}</span>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Payment Information */}
                                        <div className="mb-6 bg-blue-50 p-4 rounded-lg border border-blue-100">
                                            <h4 className="text-blue-800 font-bold text-xs uppercase tracking-wider mb-3 flex items-center gap-2">
                                                <CheckSquare size={14}/> {text.paymentHeader}
                                            </h4>
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                                <div>
                                                    <label className="text-xs text-blue-600 mb-1 block">{text.paymentMethod}</label>
                                                    <input 
                                                        type="text" 
                                                        placeholder="e.g. KBZ Pay"
                                                        className="w-full bg-transparent border-b border-blue-200 focus:border-blue-500 outline-none text-sm text-gray-700 placeholder-blue-200/70 py-2"
                                                        value={invoiceData.paymentInfo.method}
                                                        onChange={(e) => setInvoiceData({
                                                            ...invoiceData, 
                                                            paymentInfo: {...invoiceData.paymentInfo, method: e.target.value}
                                                        })}
                                                    />
                                                </div>
                                                <div>
                                                    <label className="text-xs text-blue-600 mb-1 block">{text.accName}</label>
                                                    <input 
                                                        type="text" 
                                                        placeholder="Name"
                                                        className="w-full bg-transparent border-b border-blue-200 focus:border-blue-500 outline-none text-sm text-gray-700 placeholder-blue-200/70 py-2"
                                                        value={invoiceData.paymentInfo.accountName}
                                                        onChange={(e) => setInvoiceData({
                                                            ...invoiceData, 
                                                            paymentInfo: {...invoiceData.paymentInfo, accountName: e.target.value}
                                                        })}
                                                    />
                                                </div>
                                                <div>
                                                    <label className="text-xs text-blue-600 mb-1 block">{text.accNum}</label>
                                                    <input 
                                                        type="text" 
                                                        placeholder="000-000-000"
                                                        className="w-full bg-transparent border-b border-blue-200 focus:border-blue-500 outline-none text-sm text-gray-700 placeholder-blue-200/70 py-2"
                                                        value={invoiceData.paymentInfo.accountNumber}
                                                        onChange={(e) => setInvoiceData({
                                                            ...invoiceData, 
                                                            paymentInfo: {...invoiceData.paymentInfo, accountNumber: e.target.value}
                                                        })}
                                                    />
                                                </div>
                                            </div>
                                        </div>

                                        {/* Footer / Notes */}
                                        <div className="border-t border-gray-200 pt-6">
                                            <label className="block text-gray-500 font-medium mb-2 text-xs uppercase tracking-wider">{text.note}</label>
                                            <textarea 
                                                className="w-full bg-gray-50 p-3 rounded-lg border-none resize-none text-sm text-gray-600 focus:ring-1 focus:ring-blue-500 outline-none"
                                                rows="3"
                                                placeholder="Thank you for your business..."
                                                value={invoiceData.note}
                                                onChange={(e) => setInvoiceData({...invoiceData, note: e.target.value})}
                                            />
                                        </div>

                                        {/* Digimetric Footer */}
                                        <div className="mt-8 text-center">
                                            <p className="text-xs text-gray-400 opacity-50">Created by Digimetric</p>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<InvoiceApp />);
    </script>
</body>
</html>
